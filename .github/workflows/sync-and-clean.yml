name: üîÅ Sync Printful to Stripe & Update Metadata

on:
  schedule:
    - cron: '0 6 * * *' # daily at 6 AM UTC
  workflow_dispatch:

jobs:
  sync-and-update:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    concurrency:
      group: printful-stripe-sync
      cancel-in-progress: false

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      # --- TEST ---
      - name: üîÑ Sync Printful ‚Üí Stripe (TEST)
        env:
          DRY_RUN: "false"
          MODE: "test"
          PRINTFUL_TOKEN: ${{ secrets.PRINTFUL_TOKEN }}
          PRINTFUL_STORE_ID: ${{ secrets.PRINTFUL_STORE_ID }}
          STRIPE_SECRET_KEY: ${{ secrets.STRIPE_SECRET_TEST }}
        run: node sync-printful-to-stripe.js

      # --- LIVE ---
      - name: üîÑ Sync Printful ‚Üí Stripe (LIVE)
        env:
          DRY_RUN: "false"
          MODE: "live"
          PRINTFUL_TOKEN: ${{ secrets.PRINTFUL_TOKEN }}
          PRINTFUL_STORE_ID: ${{ secrets.PRINTFUL_STORE_ID }}
          STRIPE_SECRET_KEY: ${{ secrets.STRIPE_SECRET_TEST }}
        run: node sync-printful-to-stripe.js